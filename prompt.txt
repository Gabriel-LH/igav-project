Sistema de Descuentos, Promociones y Bundles

Eres un agente de c√≥digo trabajando en un sistema POS en TypeScript con Zod.

Tu tarea es implementar un sistema profesional de descuentos y bundles sin alterar la arquitectura existente.

üîí RESTRICCI√ìN ABSOLUTA DE MODIFICACI√ìN

NO modificar, reestructurar ni refactorizar:

productSchema

inventorySchema

stockSchema

Estructuras base ya existentes

Relaciones entre modelos actuales

Nombres de archivos existentes

NO renombrar campos.
NO mover archivos.
NO crear carpetas nuevas innecesarias.
NO cambiar tipos existentes si no es estrictamente requerido.

Solo modificar lo que se indica expl√≠citamente.

üéØ OBJETIVO

Implementar:

Descuentos individuales

Promociones din√°micas

Bundles estructurados

Reglas de seguridad

Soporte para venta y alquiler

Sin romper compatibilidad con el sistema actual.

1Ô∏è‚É£ MODIFICACI√ìN PERMITIDA EN saleItemSchema

SI y SOLO SI los campos no existen, agregar:

listPrice: number

priceAtMoment: number

discountAmount: number

discountReason?: string

promotionId?: string

bundleId?: string

No eliminar nada existente.
No cambiar tipos actuales.
Solo extender el schema si falta alguno.

2Ô∏è‚É£ MODIFICACI√ìN EN rentalItemSchema

Replicar exactamente los mismos campos financieros que en saleItemSchema.

No alterar l√≥gica de fechas ni penalidades existentes.

3Ô∏è‚É£ CREAR ENTIDAD Promotion (SI NO EXISTE)

Crear archivo:

types/promotion/type.promotion.ts

No modificar otros modelos.

Definir:

id: string

name: string

type: "percentage" | "fixed_amount" | "bundle"

scope: "global" | "category" | "product_specific" | "pack"

value?: number

bundleConfig?:

requiredProductIds: string[]

bundlePrice: number

prorateStrategy: "proportional" | "equal"

isExclusive: boolean (default true)

startDate: Date

endDate?: Date

isActive: boolean

No mezclar Promotion con BusinessRules.

4Ô∏è‚É£ MODIFICACI√ìN PERMITIDA EN businessRulesSchema

Solo agregar si no existen:

maxDiscountPercentageAllowed: number

requireAdminAuthForDiscountOver: number

allowStackingDiscounts: boolean

No agregar l√≥gica de promociones aqu√≠.
BusinessRules es solo seguridad.

5Ô∏è‚É£ DIFERENCIAS OBLIGATORIAS

promotionId:

Representa la regla de marketing aplicada

Se usa para reportes

bundleId:

Representa la instancia espec√≠fica del pack en esta venta

Se genera con crypto.randomUUID()

Permite m√∫ltiples packs iguales en una transacci√≥n

Nunca eliminar bundleId.
Nunca usar promotionId para agrupar visualmente.

6Ô∏è‚É£ MOTOR DE PRICING (IMPLEMENTAR COMO FUNCI√ìN AISLADA)

Crear funci√≥n pura:

applyPricingEngine()

No mezclar con UI.
No mezclar con base de datos.

Orden obligatorio:

Tomar listPrice

Si acci√≥n expl√≠cita de bundle ‚Üí aplicar bundle

Si no es exclusivo ‚Üí evaluar promociones autom√°ticas

Elegir mejor promoci√≥n

Validar stacking con BusinessRules

Validar descuento manual contra l√≠mites

Retornar snapshot final

La funci√≥n debe ser determin√≠stica y sin efectos secundarios.

7Ô∏è‚É£ BUNDLES

NO detectar bundles autom√°ticamente por coincidencia de productos.

Debe existir funci√≥n expl√≠cita:

addBundleToCart(promotionId: string)

Proceso:

Obtener bundleConfig

Insertar productos requeridos

Calcular totalList

factor = bundlePrice / totalList

priceAtMoment = listPrice * factor

discountAmount = listPrice - priceAtMoment

Asignar promotionId

Generar bundleId √∫nico por pack

Permitir m√∫ltiples bundles iguales con distinto bundleId.

8Ô∏è‚É£ REGLAS DE EXCLUSIVIDAD

Si promotion.isExclusive === true:

Bloquear promociones adicionales

Bloquear descuento manual

Ignorar promociones globales

Si allowStackingDiscounts === false:

Aplicar √∫nicamente el mejor descuento

Nunca aplicar stacking si est√° deshabilitado.

9Ô∏è‚É£ RESTRICCIONES DE SEGURIDAD

No:

Modificar precios base

Aplicar descuentos m√∫ltiples sin validaci√≥n

Alterar datos hist√≥ricos

Crear l√≥gica oculta dentro de modelos

Introducir dependencias innecesarias

Cambiar estructura de base de datos existente

üîü PRINCIPIO DE MODIFICACI√ìN M√çNIMA

Antes de modificar cualquier archivo:

Verificar si el campo ya existe.

Si existe, no modificarlo.

Si no existe, extender sin romper compatibilidad.

No eliminar c√≥digo previo.

üß† DEFINICI√ìN FINAL

Implementar:

Mixed Bundling con prorrateo proporcional y exclusividad configurable.

Mantener separaci√≥n estricta:

Product ‚Üí Precio base inmutable
Promotion ‚Üí Marketing din√°mico
BusinessRules ‚Üí Seguridad
Pricing Engine ‚Üí C√°lculo aislado
SaleItem ‚Üí Snapshot financiero
bundleId ‚Üí Agrupaci√≥n transaccional

No improvisar arquitectura.
No reestructurar proyecto.
Modificar solo lo estrictamente necesario.